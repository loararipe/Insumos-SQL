
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valorcafe Logistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
    #loading-screen {
      position: fixed; inset: 0; background: white; z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
    }
    .spinner {
      width: 50px; height: 50px; border: 5px solid #f3f3f3;
      border-top: 5px solid #F9A11B; border-radius: 50%;
      animation: spin 1s linear infinite; margin-bottom: 1.5rem;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-text { font-weight: 800; color: #3D231A; font-size: 14px; letter-spacing: 0.2em; text-transform: uppercase; }
  </style>

  <script>window.process = { env: { API_KEY: "" } };</script>

  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0?dev",
    "react-dom": "https://esm.sh/react-dom@19.0.0?dev",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client?dev",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
  <div id="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Iniciando ValorCafé...</div>
    <div id="status-log" style="margin-top: 20px; font-size: 10px; color: #94a3b8; font-family: monospace; max-width: 80%; text-align: center;"></div>
  </div>
  
  <div id="root"></div>

  <script type="text/babel">
    // Lista de arquivos na ordem de dependência
    const FILES = [
      'types.ts',
      'utils/export.ts',
      'services/geminiService.ts',
      'components/ProductInput.tsx',
      'components/Logo.tsx',
      'components/RotaView.tsx',
      'App.tsx',
      'index.tsx'
    ];

    const blobUrls = {};

    function log(msg) {
      console.log(msg);
      document.getElementById('status-log').innerText = msg;
    }

    // Resolve caminhos como '../types' ou './components/Logo'
    function resolveImportPath(currentFile, importPath) {
      if (!importPath.startsWith('.')) return importPath;
      
      let currentDir = currentFile.split('/').slice(0, -1);
      let importParts = importPath.split('/');
      
      for (let part of importParts) {
        if (part === '.') continue;
        if (part === '..') currentDir.pop();
        else currentDir.push(part);
      }
      
      let resolved = currentDir.join('/');
      
      // Adiciona extensões se faltarem
      if (!resolved.includes('.')) {
        if (resolved.includes('components/') || resolved.endsWith('App') || resolved.endsWith('index')) {
          resolved += '.tsx';
        } else {
          resolved += '.ts';
        }
      }
      
      return resolved.startsWith('./') ? resolved : './' + resolved;
    }

    async function bootstrap() {
      try {
        for (const file of FILES) {
          const fetchPath = file.startsWith('./') ? file : './' + file;
          log(`Lendo ${file}...`);
          
          const response = await fetch(fetchPath);
          if (!response.ok) throw new Error(`Não foi possível ler o arquivo: ${file}`);
          const code = await response.text();

          log(`Processando ${file}...`);
          
          const transformed = Babel.transform(code, {
            presets: [
              ['react', { runtime: 'automatic' }],
              ['typescript', { isTSX: true, allExtensions: true }]
            ],
            filename: file,
            sourceMaps: false,
            // IMPORTANTE: Mantém como ESM para não gerar 'require is not defined'
            plugins: [
              ({ types: t }) => ({
                visitor: {
                  ImportDeclaration(pathNode) {
                    const source = pathNode.node.source.value;
                    if (source.startsWith('.')) {
                      const resolved = resolveImportPath(file, source);
                      const key = resolved.startsWith('./') ? resolved : './' + resolved;
                      if (blobUrls[key]) {
                        pathNode.node.source.value = blobUrls[key];
                      }
                    }
                  },
                  ExportNamedDeclaration(pathNode) {
                    if (pathNode.node.source && pathNode.node.source.value.startsWith('.')) {
                      const resolved = resolveImportPath(file, pathNode.node.source.value);
                      const key = resolved.startsWith('./') ? resolved : './' + resolved;
                      if (blobUrls[key]) {
                        pathNode.node.source.value = blobUrls[key];
                      }
                    }
                  }
                }
              })
            ]
          }).code;

          const blob = new Blob([transformed], { type: 'application/javascript' });
          blobUrls['./' + file] = URL.createObjectURL(blob);
        }

        log("Iniciando interface...");
        // Executa o index.tsx compilado
        const entryPoint = document.createElement('script');
        entryPoint.type = 'module';
        entryPoint.src = blobUrls['./index.tsx'];
        document.body.appendChild(entryPoint);

        // Aguarda um pouco para remover a tela de carga
        setTimeout(() => {
          const loader = document.getElementById('loading-screen');
          if (loader) {
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
          }
        }, 800);

      } catch (err) {
        console.error("Erro fatal:", err);
        document.getElementById('loading-screen').innerHTML = `
          <div style="text-align: center; color: #ef4444; padding: 30px; background: #fff1f2; border-radius: 20px; border: 1px solid #fecaca; max-width: 90%;">
            <i class="fas fa-bug" style="font-size: 40px; margin-bottom: 20px;"></i>
            <h2 style="font-weight: 800; margin-bottom: 10px;">Falha Crítica</h2>
            <p style="font-size: 13px; font-family: monospace; background: white; padding: 10px; border-radius: 8px;">${err.message}</p>
            <button onclick="location.reload()" style="margin-top: 20px; background: #3D231A; color: white; padding: 12px 24px; border-radius: 10px; font-weight: bold;">Tentar Recarregar</button>
          </div>
        `;
      }
    }

    bootstrap();
  </script>
</body>
</html>
